目录批量 PDF → Markdown 转换工具
（基于自建 Llama.cpp OCR 模型的异步 Python 脚本）需求文档

# 1. 背景与目标

## 1.1 背景

当前已有一套基于 Llama.cpp 部署的多模态 OCR 模型：

```bash
HIP_VISIBLE_DEVICES=0 \
./build-hip/bin/llama-server \
  --model /mnt/ssd/models/chandra-ocr/chandra-Q4_K_M.gguf \
  --mmproj /mnt/ssd/models/chandra-ocr/chandra-mmproj-f16.gguf \
  --ctx-size 25600 \
  --n-gpu-layers -1 \
  --jinja \
  --flash-attn on \
  --host 0.0.0.0 \
  --port 8082 \
  --alias chandra-ocr
```

模型已通过 `/v1/chat/completions` 接口对外提供 OCR 能力。

## 1.2 目标

开发一个 **Python 异步脚本**，对指定目录（含子目录）下所有 PDF 文件进行批量处理，通过自建 OCR 模型提取内容，并生成结构化的 Markdown 文档。

# 2. 范围说明

## 2.1 输入范围

- 指定一个 **根目录**，递归遍历该目录及子目录。
- 仅处理扩展名为 `.pdf` 的文件。
- 其他文件类型忽略。

## 2.2 输出范围

- 为每个 PDF 生成 **对应的 Markdown 文件**（`.md`）。
- 输出目录结构与输入目录保持镜像（子目录层级对应）。

# 3. 术语约定

- **OCR 模型**：指已部署的 `chandra-ocr` 模型，通过 Llama.cpp `llama-server` 提供的 HTTP 接口访问。
- **页面（Page）**：PDF 中的单个页。
- **Chunk**：可选，用于指代将一页或多页内容切分后的最小处理单元。
- **任务（Task）**：对单个 PDF 或单个页面进行 OCR 并生成 Markdown 片段的逻辑单元。

# 4. 总体流程描述

1. 启动脚本，读取配置（输入目录、输出目录、并发数、模型地址等）。
2. 递归扫描输入目录，收集所有 PDF 文件路径。
3. 对每个 PDF：
   - 打开文件，按页读取内容：
     - 若是图片型 PDF：渲染/转换为图片（如每页一张）。
     - 若 PDF 自带可选文本层，可配置为：
       - 直接提取文本（不调用 OCR），或
       - 统一按图片走 OCR（可配置）。
   - 针对每一页（或每个 chunk），构造 OCR 请求，调用 `chandra-ocr` 模型。
   - 收集模型返回的文本结果，按页顺序拼接为 Markdown 内容。
4. 将生成的 Markdown 内容保存为 `.md` 文件，写入输出目录（保持子目录结构）。
5. 全流程使用 Python 异步（`asyncio`）实现并发，加速批量处理。
6. 记录日志与错误信息，完成后输出整体统计（成功/失败文件数、平均耗时等）。

# 5. 功能需求

## 5.1 目录扫描与任务发现

- **必须**：支持从命令行指定输入根目录 `--input-dir`。
- **必须**：递归遍历子目录，找到所有 `.pdf` 文件。
- **必须**：忽略隐藏文件（例如以 `.` 开头）可作为配置项。
- **可选**：支持文件过滤（例如排除某些模式的文件名或路径）。

## 5.2 PDF 解析与分页

- **必须**：对每个 PDF 按页读取：
  - 支持获取页数、页序号。
- **必须**：支持将页面渲染/转成图像，供 OCR 模型识别。
- **可选**：检测是否存在文本层：
  - 若存在且配置允许，直接提取 PDF 文本；
  - 否则走图像 OCR。

## 5.3 调用 OCR 模型提取内容

- **必须**：通过 HTTP 调用当前部署的 `llama-server`：
  - 基础信息：
    - Host：可配置，默认 `http://0.0.0.0:8082`
    - 接口：`/v1/chat/completions`
    - 模型别名：`chandra-ocr`
  - 调用方式：
    - POST JSON 请求，Chat 格式为 “Hermes 2 Pro” / OpenAI Chat 兼容格式。
    - 支持传入图片（例如将页面图像以 base64 或本地文件 URL 形式提供），并带入说明性 prompt，如“请做高质量 OCR，保留段落结构”。
- **必须**：每页/每 chunk 控制在 **上下文限制内**（`--ctx-size 25600`）：
  - 单次请求只处理少量页（推荐：每次 1 页，或配置支持 N 页）。
  - 若检测或收到 `the request exceeds the available context size` 错误，需要自动降级策略：
    - 减少一次请求包含的页数，或
    - 将当前任务标记为失败并记录。

## 5.4 Markdown 内容生成

- **必须**：为每个 PDF 生成一个 `.md` 文件。
- **必须**：内容组织形式建议如下：
  - 文件级标题：`# <原 PDF 文件名>`（不带扩展名）。
  - 页级分隔（推荐其一，需在文档中固定）：
    - 方案 A：`## Page <N>` 作为页标题；或
    - 方案 B：使用分隔线 `---` 并附带页号注释。
- **必须**：对于 OCR 失败或超时的页面：
  - 在 Markdown 中插入占位标记，例如：
    - `> [OCR FAILED] Page N`
  - 并在文末附“失败页列表”。

## 5.5 输出文件与目录结构

- **必须**：输出根目录通过命令行参数 `--output-dir` 指定。
- **必须**：保持子目录结构镜像，例如：

```text
输入:  /input/a/b/doc1.pdf
输出:  /output/a/b/doc1.md
```

- **必须**：输出文件命名规则：
  - 将 `.pdf` 扩展名替换为 `.md`；
  - 对包含非法文件名字符的情况进行清洗（例如空格、特殊符号）。

## 5.6 日志与统计

- **必须**：输出 INFO 级日志，内容包括：
  - 当前处理的 PDF 路径；
  - 每个 PDF 的页数；
  - 每页 OCR 请求的开始/结束、是否成功；
  - 请求错误（HTTP 错误码、超时、context 超限等）。
- **必须**：在脚本结束时打印总统计信息：
  - 成功转换 PDF 数量；
  - 失败 PDF 数量及原因；
  - 总耗时与平均每文件耗时。

# 6. 非功能需求

## 6.1 性能与并发（异步要求）

- **必须**：脚本基于 Python 异步实现：
  - 使用 `asyncio` 作为基础；
  - HTTP 客户端建议使用 `aiohttp` 或 `httpx`（async 模式）。
- **必须**：支持配置最大并发数，例如：
  - `--max-concurrency`（默认值如 4 或 8）。
- **必须**：使用信号量/连接池等方式，限制同时访问 OCR 模型的请求数量，防止模型过载。
- **可选**：区分“文件级并发”和“页级并发”的策略（例如：一次并发处理多个 PDF，每个 PDF 内的页序列化处理）。

## 6.2 可靠性与重试

- **必须**：对于网络层错误（如连接超时、临时 5xx），进行有限次数重试：
  - 可配置参数：`--max-retries`（例如 3 次）。
  - 重试间隔：可采用固定间隔或指数退避。
- **必须**：对失败的页面/文件进行记录（日志 + 可选的失败清单文件），避免整个任务因单个文件失败而中断。

## 6.3 配置管理

- **必须**：支持通过命令行参数配置：
  - `--input-dir`：输入目录；
  - `--output-dir`：输出目录；
  - `--max-concurrency`：最大并发数；
  - `--max-retries`：重试次数；
  - `--server-url`：OCR 服务地址（默认 `http://0.0.0.0:8082`）；
  - `--model`：模型别名（默认 `chandra-ocr`）；
  - 请求超时、单次处理页数等。
- **可选**：支持从配置文件（如 `config.yaml` 或 `.env`）加载默认配置。

# 7. 与 OCR 模型的接口约定（概要）

> 这里只做需求层的约定，具体字段可在开发阶段根据 `llama-server` 的 OpenAI 兼容格式细化。

- **接口地址**：`POST {server-url}/v1/chat/completions`
- **关键字段要求**：
  - `model`: 使用 `chandra-ocr`；
  - `messages`: 包含用户指令和图像内容；
  - `temperature` / `top_p` / ...：可按部署参数设置默认值，也可在脚本中固定。
- **错误场景**：
  - HTTP 400，特别是 `the request exceeds the available context size`；
  - HTTP 5xx；
  - 网络超时。
- **需求**：脚本需能够根据返回结果解析文本内容，并在错误时进行相应的重试或失败记录。

# 8. 命令行使用示例（需求）

**基本示例：**

```bash
python convert_pdfs_to_md.py \
  --input-dir /data/pdfs \
  --output-dir /data/mds \
  --server-url http://0.0.0.0:8082 \
  --model chandra-ocr \
  --max-concurrency 4 \
  --max-retries 3
```

**期望行为：**

- 运行结束后，在 `/data/mds` 下生成与 `/data/pdfs` 同结构的 `.md` 文件；
- 控制台输出整体统计摘要。

# 9. 扩展与后续规划（可选）

- 支持：
  - 纯文本 PDF 直接抽取文本，不调用 OCR；
  - 针对表格类内容使用不同 prompt，提示模型输出 Markdown 表格；
  - 通过配置不同 prompt 模板，应对不同类型文档（试卷、书籍、报告等）。
- 与其他系统集成：
  - 后续可以将该脚本封装为服务或集成到 Dify / n8n 流程中，但不在本次需求范围内。